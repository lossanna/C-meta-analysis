---
title: "Exotic outliers for models"
author: "Lia Ossanna"
date: "2022-05-24"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r, include=FALSE, message=FALSE}
library(tidyverse)
library(readxl)
library(metafor)
load("ex-outliers.RData")
```


Analysis for Ossanna & Gornish (2022), “Efficacy of labile carbon addition to reduce exotic invasive plants: A review and meta-analysis”, *Journal of Applied Ecology*.


# Introduction
- This is the analysis to identify outliers in the single-moderator models, and relevant models generated through model selection.


## Hat values and standardized residuals
- The first method for determining outliers is from Habeck 2015 (*AoB Plants*):
  + "In lieu of other options currently available within the package `metafor` when using the `rma.mv()` function, we define influential outliers as effect sizes with hat values (i.e. diagonal elements of the hat matrix) greater than two times the average hat value (i.e. influential) and standardized residual values exceeding 3.0 (i.e. outliers; Stevens 1984; Viechtbauer and Cheung 2010; Aguinis et al. 2013)."
- In other words, from Buchan 2019 (*Journal of Animal Ecology*), an observation is considered an outlier if it is "more than double the mean hat value of the dataset and standardized residuals greater than +/-3 as an influential outlier".
- When plotted with the ratio of hat value to average hat value on the x-axis and the standardized residuals on the y-axis, horizontal lines can be added at +3 and -3, and a vertical line at 2. Outliers will fall in the top right or bottom right box.
  + Outliers are identified by adding labels to the points (`text(hat, rstn$resid, labels = ex$obs_ID, cex = 1, pos = 4)`), but this makes most of the plot unreadable, so this code is omitted. The paper and other relevant information for outliers are extracted.
- Code for this analysis was taken from Habeck 2015; Buchan 2019 used the same code.

## Studentized deleted residuals
- The second method is adapted from Viechtbauer 2010 (*Research Synthesis Methods*).
- Outliers are defined as having studentized deleted residuals outside the bounds of +/-1.96, but should not necessarily be deleted because of this basis alone; such cases "may call for closer inspection", and "one could consider finding more than *k*/10 studentized deleted residuals larger than +/-1.96 in a set of *k* studies as unusual."
  + However, this is computationally intensive. According to the `metafor` documentation, using the argument `reestimate = FALSE` in the `rstudent()` function approximates the residuals ("any variance/correlation components in the model are not re-estimated after deleting the *i*th case from the dataset"), and "often yields similar results".
- Calculate DFBETAS values to identify the influence of removing the *i*th case; DFBETAS > +/-1 indicate influential cases.
  + Similarly, `reestimate = FALSE` can be applied to the `dftbas.rma.mv()` function to speed up analysis using estimation.
- Full analysis (not estimation) was not attempted. 
- Outliers and influential points are identified by their row number in the dataset (`ex`, or subset for model selection).
- Models are noted if outliers > *k*/10, and rows with the most extreme residuals.

## Code annotations
- See Biome section for annotated code.


# Summary
- Numbers refer to `obs_ID` unless otherwise specified.

## Habeck
- Models with Habeck outliers:
  - No moderators: 457, 601
  - Region: 457, 601
  - duration_first (categorical): 457
  - Grass/forb/shrub: 257, 258
  - Seeding of native: 457
  
## Viechtbauer
- Models with Viechtbauer influential outliers:
  - C rate (categorical): 437
- Models with more outliers than *k*/10: 
  - duration_first (categorical): 59, 47, 56, 55, 51
- Models with influential points that are not outliers:
  - Biome: 468, 467
  - Region: 468, 467
  - duration_last (categorical): 11
  - C applications (categorical): 422

## Outlier set
- Outliers removed:
  - Habeck outliers
  - Viechtbauer influential outliers

- Sets by model:
  - No moderators: 457, 601
  - Biome: none
  - Region: 457, 601
  - Soil suborder: none
  - duration_first (categorical): 457
  - duration_last (categorical): none
  - C type: none
  - C rate (categorical): 437
  - C applications (categorical): none
  - Months applying C: none
  - Annual/perennial: none
  - Grass/forb/shrub: 257, 258
  - Annual/perennial and grass/forb/shrub: none
  - Plot size: none
  - Seeding of native: 457
  - Model selection 14: none

  

# Setup
```{r, eval=FALSE}
library(tidyverse)
library(readxl)
library(metafor)

# Load data ---------------------------------------------------------------

raw <- read_xlsx("data/C-addition-studies.xlsx", sheet = "screen 3_data (biocov)")
raw$plant_apgfs <- paste(raw$plant_anper, raw$plant_gfs, sep = " ")
raw$C_app_tm <- raw$duration_first - raw$duration_last
raw$C_app_ma <- raw$C_app_tm / raw$C_app

# Data wrangling
trt.cntrl.se.sd <- c("biomass_mean_trt", "biomass_SE_trt", "biomass_SD_trt",
                     "biomass_mean_cntrl", "biomass_SE_cntrl", "biomass_SD_cntrl")
to.drop <- c("biomass_SE_trt", "biomass_SE_cntrl", "to_sd_trt", "to_sd_cntrl")
biomass <- raw %>% 
  select(!(contains("cover"))) %>% 
  select(!contains("density")) %>% 
  filter(!is.na(biomass_mean_trt)) %>% 
  mutate_at(trt.cntrl.se.sd, as.numeric) %>% 
  mutate(to_sd_trt = biomass_SE_trt * sqrt(n_trt)) %>% 
  mutate(to_sd_cntrl = biomass_SE_cntrl * sqrt(n_cntrl)) %>% 
  mutate(biomass_SD_trt = paste(biomass_SD_trt, to_sd_trt)) %>% 
  mutate(biomass_SD_trt = str_remove(biomass_SD_trt, pattern = "NA"), .keep = "unused") %>% 
  mutate(biomass_SD_cntrl = paste(biomass_SD_cntrl, to_sd_cntrl)) %>% 
  mutate(biomass_SD_cntrl = str_remove(biomass_SD_cntrl, pattern = "NA"), .keep = "unused") %>% 
  select(-all_of(to.drop)) %>% 
  mutate_at(c("biomass_SD_trt", "biomass_SD_cntrl"), as.numeric) %>% 
  rename(mean_trt = biomass_mean_trt) %>% 
  rename(mean_cntrl = biomass_mean_cntrl) %>% 
  rename(SD_trt = biomass_SD_trt) %>% 
  rename(SD_cntrl = biomass_SD_cntrl)
biomass$res <- rep("biomass", nrow(biomass))

trt.cntrl.se.sd <- c("cover_mean_trt", "cover_SE_trt", "cover_SD_trt",
                     "cover_mean_cntrl", "cover_SE_cntrl", "cover_SD_cntrl")
to.drop <- c("cover_SE_trt", "cover_SE_cntrl", "to_sd_trt", "to_sd_cntrl")
cover <- raw %>% 
  select(!(contains("biomass"))) %>% 
  select(!contains("density")) %>% 
  filter(!is.na(cover_mean_cntrl)) %>% 
  mutate_at(trt.cntrl.se.sd, as.numeric) %>% 
  mutate(to_sd_trt = cover_SE_trt * sqrt(n_trt)) %>% 
  mutate(to_sd_cntrl = cover_SE_cntrl * sqrt(n_cntrl)) %>% 
  mutate(cover_SD_trt = paste(cover_SD_trt, to_sd_trt)) %>% 
  mutate(cover_SD_trt = str_remove(cover_SD_trt, pattern = "NA"), .keep = "unused") %>% 
  mutate(cover_SD_cntrl = paste(cover_SD_cntrl, to_sd_cntrl)) %>% 
  mutate(cover_SD_cntrl = str_remove(cover_SD_cntrl, pattern = "NA"), .keep = "unused") %>% 
  select(-all_of(to.drop)) %>% 
  mutate_at(c("cover_SD_trt", "cover_SD_cntrl"), as.numeric)  %>% 
  rename(mean_trt = cover_mean_trt) %>% 
  rename(mean_cntrl = cover_mean_cntrl) %>% 
  rename(SD_trt = cover_SD_trt) %>% 
  rename(SD_cntrl = cover_SD_cntrl) # warning because one Burke point is blank (was <1)
cover$res <- rep("cover", nrow(cover))

all.1res <- rbind(biomass, cover)


# Calculating effect size -------------------------------------------------

ex <- all.1res %>%
  filter(str_detect(plant_category, "exotic"))

ex <- escalc(measure = "SMD",
             n1i = n_trt,
             n2i = n_cntrl,
             m1i = mean_trt,
             m2i = mean_cntrl,
             sd1i = SD_trt,
             sd2i = SD_cntrl,
             data = ex)

ex <- ex %>% 
  filter(!is.na(yi)) # 568 to 488 obs



# Categorical versions ----------------------------------------------------

ex$dfc <- NA
for(i in 1:nrow(ex)) {
  if(ex$duration_first[i] == 3) {
    ex$dfc[i] <- "3"
  } else if(between(ex$duration_first[i], 5, 6)) {
    ex$dfc[i] <- "5-6"
  } else if(between(ex$duration_first[i], 7, 12)) {
    ex$dfc[i] <- "7-12"
  } else if(between(ex$duration_first[i], 12, 18)) {
    ex$dfc[i] <- "12-18"
  } else if(between(ex$duration_first[i], 19, 24)) {
    ex$dfc[i] <- "19-24"
  } else if(between(ex$duration_first[i], 25, 36)) {
    ex$dfc[i] <- "25-36"
  } else if(between(ex$duration_first[i], 37, 50)) {
    ex$dfc[i] <- "37-50"
  } else if(between(ex$duration_first[i], 100, 200)) {
    ex$dfc[i] <- "100-200"
  } else {
    ex$dfc[i] <- ">200"
  }
}
ex$dfc <- factor(ex$df, levels = c("3", "5-6", "7-12", "12-18", "19-24", "25-36", "37-50", "100-200", ">200"))

ex$dlc <- NA
for(i in 1:nrow(ex)) {
  if(between(ex$duration_last[i], 0, 1.5)) {
    ex$dlc[i] <- "0-1.5"
  } else if(ex$duration_last[i] == 2) {
    ex$dlc[i] <- "2"
  } else if(between(ex$duration_last[i], 3, 3.5)) {
    ex$dlc[i] <- "3-3.5"
  } else if(between(ex$duration_last[i], 4, 6)) {
    ex$dlc[i] <- "4-6"
  } else if(between(ex$duration_last[i], 7, 12)) {
    ex$dlc[i] <- "7-12"
  } else if(between(ex$duration_last[i], 13, 18)) {
    ex$dlc[i] <- "13-18"
  } else if(between(ex$duration_last[i], 19, 24)) {
    ex$dlc[i] <- "19-24"
  } else if(between(ex$duration_last[i], 36, 49)) {
    ex$dlc[i] <- "36-49"
  } else {
    ex$dlc[i] <- ">100"
  }
}
ex$dlc <- factor(ex$dl, levels = c("0-1.5", "2", "3-3.5", "4-6", "7-12", "13-18", "19-24", 
                                   "36-49", ">100"))

ex$cratc <- NA
for(i in 1:nrow(ex)) {
  if(is.na(ex$C_rate[i])) {
    ex$cratc[i] <- "idk"
  } else if(between(ex$C_rate[i], 0, 100)) {
    ex$cratc[i] <- "30-100"
  } else if(between(ex$C_rate[i], 101, 160)) {
    ex$cratc[i] <- "133-160"
  } else if(between(ex$C_rate[i], 161, 200)) {
    ex$cratc[i] <- "174-200"
  } else if(between(ex$C_rate[i], 201, 300)) {
    ex$cratc[i] <- "210-300"
  } else if(between(ex$C_rate[i], 301, 400)) {
    ex$cratc[i] <- "330-400"
  } else if(between(ex$C_rate[i], 401, 500)) {
    ex$cratc[i] <- "420-500"
  } else if(between(ex$C_rate[i], 501, 600)) {
    ex$cratc[i] <- "506-600"
  } else if(between(ex$C_rate[i], 630, 700)) {
    ex$cratc[i] <- "620-700"
  } else if(between(ex$C_rate[i], 714, 999)) {
    ex$cratc[i] <- "714-999"
  } else if(between(ex$C_rate[i], 1000, 1330)) {
    ex$cratc[i] <- "1000-1330"
  } else if(between(ex$C_rate[i], 1600, 2000)) {
    ex$cratc[i] <- "1600-2000"
  } else if(between(ex$C_rate[i], 2001, 3000)) {
    ex$cratc[i] <- "2110-3000"
  } else if(between(ex$C_rate[i], 3001, 5000)) {
    ex$cratc[i] <- "3346-5000"
  } else {
    ex$cratc[i] <- ">5000"
  }
}
ex$cratc <- factor(ex$cratc, levels = c("30-100", "133-160", "174-200", "210-300", "330-400", "420-500", 
                                        "506-600", "620-700", "714-999", "1000-1330", "1600-2000",
                                        "2110-3000", "3346-5000", ">5000"))

ex$capc <- NA
for(i in 1:nrow(ex)) {
  if(ex$C_app[i] == 1) {
    ex$capc[i] <- "1"
  } else if(ex$C_app[i] == 2) {
    ex$capc[i] <- "2"
  } else if(between(ex$C_app[i], 3, 6)) {
    ex$capc[i] <- "3-6"
  } else if(between(ex$C_app[i], 7, 10)) {
    ex$capc[i] <- "7-10"
  } else if(between(ex$C_app[i], 15, 22)) {
    ex$capc[i] <- "15-22"
  } else if(between(ex$C_app[i], 32, 40)) {
    ex$capc[i] <- "32-40"
  } else {
    ex$capc[i] <- ">40"
  }
}
ex$capc <- factor(ex$capc, levels = c("1", "2", "3-6", "7-10", "15-22", "32-40", ">40"))


ex$capt <- NA
for(i in 1:nrow(ex)) {
  if(ex$C_app_tm[i] == 0) {
    ex$capt[i] <- "1 application total"
  } else if(between(ex$C_app_tm[i], 0.001, 6)) {
    ex$capt[i] <- "1-6"
  } else if(between(ex$C_app_tm[i], 7, 12)) {
    ex$capt[i] <- "7-12"
  } else if(between(ex$C_app_tm[i], 13, 24)) {
    ex$capt[i] <- "13-24"
  } else if(between(ex$C_app_tm[i], 25, 36)) {
    ex$capt[i] <- "25-36"
  } else if(between(ex$C_app_tm[i], 37, 48)) {
    ex$capt[i] <- "37-48"
  } else {
    ex$capt[i] <- ">48"
  }
}
ex$capt <- factor(ex$capt, levels = c("1 application total", "1-6", "7-12", "13-24", 
                                      "25-36", "37-48", ">48"))

ex$plotc <- NA
for(i in 1:nrow(ex)) {
  if(is.na(ex$plot[i])) {
    ex$plotc[i] <- "idk"
  } else if(ex$plot[i] < 1) {
    ex$plotc[i] <- "<1"
  } else if(ex$plot[i] == 1) {
    ex$plotc[i] <- "1"
  } else if(between(ex$plot[i], 1.3, 3.75)) {
    ex$plotc[i] <- "1.3-3.75"
  } else if(ex$plot[i] == 4) {
    ex$plotc[i] <- "4"
  } else if(between(ex$plot[i], 6, 9)) {
    ex$plotc[i] <- "6-9"
  } else if(ex$plot[i] == 12) {
    ex$plotc[i] <- "12"
  } else if(between(ex$plot[i], 12.5, 16)) {
    ex$plotc[i] <- "12.5-16"
  } else if(ex$plot[i] == 25) {
    ex$plotc[i] <- "25"
  } else if(between(ex$plot[i], 28, 50)) {
    ex$plotc[i] <- "28-50"
  } else if(ex$plot[i] == 75) {
    ex$plotc[i] <- "75"
  } else {
    ex$plotc[i] <- ">100"
  }
}
ex$plotc <- factor(ex$plotc, 
                   levels = c("<1", "1", "1.3-3.75", "4", "6-9", "12", "12.5-16", 
                              "25", "28-50", "75", ">100"))

ex$seedn <- NA
for(i in 1:nrow(ex)) {
  if(is.na(ex$seeding_native[i])) {
    ex$seedn[i] <- "native seeded"
  } else if(ex$seeding_native[i] == 0) {
    ex$seedn[i] <- "native not seeded"
  } else {
    ex$seedn[i] <- "native seeded"
  }
}
```



# No moderators (summary effect)
```{r, eval=FALSE}
ex.mv <- rma.mv(yi = yi,
                V = vi,
                random = ~ 1 | exp_ID / obs_ID,
                data = ex)
```

## Habeck method
```{r}
rstn <- rstandard(ex.mv)
hat <- hatvalues(ex.mv) / mean(hatvalues(ex.mv))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "no moderators")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

Habeck outliers
```{r}
filter(ex, obs_ID == 457)[ , c("paper", "obs_ID")]
filter(ex, obs_ID == 601)[ , c("paper", "obs_ID")]
```

## Viechtbauer method
### Estimate
```{r, eval=FALSE}
rstd <- rstudent(ex.mv, reestimate = FALSE, progbar = TRUE) # ~ 4 min (ThinkPad)
```
```{r}
x <- subset(rstd, rstd$resid > 1.96)
y <- subset(rstd, rstd$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv$k / 10
```
```{r, eval=FALSE}
dfb <- dfbetas.rma.mv(ex.mv, reestimate = FALSE, progbar = TRUE) # ~ 4 min (ThinkPad)
```
```{r}
summary(dfb) # examine minimums and maximums
```

- Comparison with previous dataset that included density: outliers were observations 457 and 601.

# Biome
```{r, eval=FALSE}
ex.mv.bio <- rma.mv(yi = yi,
                    V = vi,
                    random = ~ 1 | exp_ID / obs_ID,
                    data = ex,
                    mods = ~ factor(biome) - 1)
```
- Run multilevel model with `biome` as a moderator.

## Habeck method
```{r}
rstn <- rstandard(ex.mv.bio)
hat <- hatvalues(ex.mv.bio) / mean(hatvalues(ex.mv.bio))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "biome")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

- The above chunk of code came directly from the Habeck 2015 paper.
- Habeck outliers are points in the top right and bottom right sections.

```{r}
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "biome")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

-  Points can be identified by `obs_ID`. Labels are assigned to each point using `text()` (see Introduction), which makes the plot very messy, so that is omitted here.

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.bio <- rstudent(ex.mv.bio, reestimate = FALSE, progbar = TRUE)
```
```{r}
x <- subset(rstd.bio, rstd.bio$resid > 1.96)
y <- subset(rstd.bio, rstd.bio$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.bio$k / 10
```
- Subset points with studentized deleted residual >1.96 and <-1.96. 
- Then ensure number of points < *k*/10 (it is; 37 < 48.7).

```{r, eval=FALSE}
dfb.bio <- dfbetas.rma.mv(ex.mv.bio, reestimate = FALSE, progbar = TRUE)
```
```{r}
summary(dfb.bio)
```
- Check the minimums and maximums of each moderator level and identify which level has a minimum < -1 or a maximum > 1.
- In this case, `fynbos` has a max > 1 and min < -1.
```{r}
subset(dfb.bio, dfb.bio$factor.biome.fynbos > 1) # 339
```
- Use `subset()` to identify rows of `ex` with max > 1.
```{r}
x$slab # none
```
- Check if points are also outliers with residuals > 1.96. See that 339 is not on the list.
```{r}
subset(dfb.bio, dfb.bio$factor.biome.fynbos < -1) # 338
y$slab # none
ex[c(339, 338), c("paper", "obs_ID", "biome")]
```
- Observations 468 and 467 are influential, but not outliers.
- Comparison with previous dataset that included density: outliers were observations 1610 and 457.
  - Observation 1610 was density data from Rashid 2010 (Kashmir Himalaya), and is not included in this new no-density `ex`.


# Region
```{r, eval=FALSE}
ex.mv.reg <- rma.mv(yi = yi,
                    V = vi,
                    random = ~ 1 | exp_ID / obs_ID,
                    data = ex,
                    mods = ~ factor(region) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.reg)
hat <- hatvalues(ex.mv.reg) / mean(hatvalues(ex.mv.reg))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "region")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

Habeck outliers
```{r}
filter(ex, obs_ID == 601)[ , c("paper", "obs_ID", "region")]
filter(ex, obs_ID == 457)[ , c("paper", "obs_ID", "region")]
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.reg <- rstudent(ex.mv.reg, reestimate = FALSE, progbar = TRUE)
```
```{r}
x <- subset(rstd.reg, rstd.reg$resid > 1.96)
y <- subset(rstd.reg, rstd.reg$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.reg$k / 10
```
```{r, eval=FALSE}
dfb.reg <- dfbetas.rma.mv(ex.mv.reg, reestimate = FALSE, progbar = TRUE)
```
```{r}
summary(dfb.reg)

subset(dfb.reg, dfb.reg$factor.region.South.Africa > 1) # 339
x$slab # none
subset(dfb.reg, dfb.reg$factor.region.South.Africa < -1) # 338
y$slab # none
ex[c(339, 338), c("paper", "obs_ID", "region")]
```
- Observations 601 and 457 are Habeck outliers.
- Observations 468 and 467 are influential, but not outliers.



# Soil suborder
```{r, eval=FALSE}
ex.mv.soil <- rma.mv(yi = yi,
                    V = vi,
                    random = ~ 1 | exp_ID / obs_ID,
                    data = ex,
                    mods = ~ factor(soil_suborder) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.soil)
hat <- hatvalues(ex.mv.soil) / mean(hatvalues(ex.mv.soil))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "soil suborder")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.soil <- rstudent(ex.mv.soil, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.soil, rstd.soil$resid > 1.96)
y <- subset(rstd.soil, rstd.soil$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.soil$k / 10
```
```{r, eval=FALSE}
dfb.soil <- dfbetas.rma.mv(be.mv.soil, reestimate = FALSE, progbar = TRUE)
```
```{r}
summary(dfb.soil)
```



# duration_first (categorical) 
```{r, eval=FALSE}
ex.mv.dfc <- rma.mv(yi = yi,
                    V = vi,
                    random = ~ 1 | exp_ID / obs_ID,
                    data = ex,
                    mods = ~ factor(dfc) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.dfc)
hat <- hatvalues(ex.mv.dfc) / mean(hatvalues(ex.mv.dfc))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "dfc")
abline(h = -3)
abline(h = 3)
abline(v = 2)

filter(ex, obs_ID == 457)[ , c("paper", "obs_ID", "dfc")]
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.dfc <- rstudent(ex.mv.dfc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.dfc, rstd.dfc$resid > 1.96)
y <- subset(rstd.dfc, rstd.dfc$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.dfc$k / 10
```
```{r, eval=FALSE}
dfb.dfc <- dfbetas.rma.mv(ex.mv.dfc, reestimate = FALSE, progbar = TRUE)
```
```{r}
summary(dfb.dfc)
```

- Observation 457 is a Habeck outlier.
- Number of outliers > *k*/10, where Observations 59, 47, 56, 55, and 51 had the largest studentized deleted residuals.
  - This does not warrant removal as an outlier; it demonstrates that `dfc` has an unusual amount of outliers, but they are not influential.



# duration_last (categorical)
```{r, eval=FALSE}
ex.mv.dlc <- rma.mv(yi = yi,
                    V = vi,
                    random = ~ 1 | exp_ID / obs_ID,
                    data = ex,
                    mods = ~ factor(dlc) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.dlc)
hat <- hatvalues(ex.mv.dlc) / mean(hatvalues(ex.mv.dlc))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "dlc")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.dlc <- rstudent(ex.mv.dlc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.dlc, rstd.dlc$resid > 1.96)
y <- subset(rstd.dlc, rstd.dlc$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.dlc$k / 10
```
```{r, eval=FALSE}
dfb.dlc <- dfbetas.rma.mv(ex.mv.dlc, reestimate = FALSE, progbar = TRUE)
```
```{r}
summary(dfb.dlc)

subset(dfb.dlc, dfb.dlc$factor.dlc..100 < -1) # 5
y$slab # none
ex[5, c("paper", "obs_ID", "dlc")]
```
- Observation 11 is influential, but not an outlier.
- Comparison with previous dataset that included density: Observations 457 and 459 are no longer influential outliers (and still present in datset).



# C type
```{r, eval=FALSE}
ex.mv.ctyp <- rma.mv(yi = yi,
                     V = vi,
                     random = ~ 1 | exp_ID / obs_ID,
                     data = ex,
                     mods = ~ factor(C_type) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.ctyp)
hat <- hatvalues(ex.mv.ctyp) / mean(hatvalues(ex.mv.ctyp))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "C_type")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.ctyp <- rstudent(ex.mv.ctyp, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.ctyp, rstd.ctyp$resid > 1.96)
y <- subset(rstd.ctyp, rstd.ctyp$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.ctyp$k / 10
```
```{r, eval=FALSE}
dfb.ctyp <- dfbetas.rma.mv(ex.mv.ctyp, reestimate = FALSE, progbar = TRUE) 
```
```{r}
summary(dfb.ctyp)
```



# C rate (categorical)
```{r, eval=FALSE}
ex.mv.cratc <- rma.mv(yi = yi,
                      V = vi,
                      random = ~ 1 | exp_ID / obs_ID,
                      data = ex,
                      mods = ~ factor(cratc) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.cratc)
hat <- hatvalues(ex.mv.cratc) / mean(hatvalues(ex.mv.cratc))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "cractc")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.cratc <- rstudent(ex.mv.cratc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.cratc, rstd.cratc$resid > 1.96)
y <- subset(rstd.cratc, rstd.cratc$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.cratc$k / 10
```
```{r, eval=FALSE}
dfb.cratc <- dfbetas.rma.mv(ex.mv.cratc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
summary(dfb.cratc)

subset(dfb.cratc, dfb.cratc$factor.cratc..5000 > 1) # 331
x$slab # 331
ex[331, c("paper", "obs_ID", "cratc")]
```

- Observation 437 is an influential outlier.



# C applications (categorical)
```{r, eval=FALSE}
ex.mv.capc <- rma.mv(yi = yi,
                     V = vi,
                     random = ~ 1 | exp_ID / obs_ID,
                     data = ex,
                     mods = ~ factor(capc) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.capc)
hat <- hatvalues(ex.mv.capc) / mean(hatvalues(ex.mv.capc))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "capc")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.capc <- rstudent(ex.mv.capc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.capc, rstd.capc$resid > 1.96)
y <- subset(rstd.capc, rstd.capc$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.capc$k / 10
```
```{r, eval=FALSE}
dfb.capc <- dfbetas.rma.mv(ex.mv.capc, reestimate = FALSE, progbar = TRUE)  
```
```{r}
summary(dfb.capc)

subset(dfb.capc, dfb.capc$factor.capc.15.22 > 1) # 322
x$slab # none
ex[322, c("paper", "obs_ID", "capc")]
```
- Observation 422 is influential, but not an outlier.




# Months applying C
```{r, eval=FALSE}
ex.mv.capt <- rma.mv(yi = yi,
                     V = vi,
                     random = ~ 1 | exp_ID / obs_ID,
                     data = ex,
                     mods = ~ factor(capt) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.capt)
hat <- hatvalues(ex.mv.capt) / mean(hatvalues(ex.mv.capt))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "capt")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.capt <- rstudent(ex.mv.capt, reestimate = FALSE, progbar = TRUE)
```
```{r}
x <- subset(rstd.capt, rstd.capt$resid > 1.96)
y <- subset(rstd.capt, rstd.capt$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.capt$k / 10
```
```{r, eval=FALSE}
dfb.capt <- dfbetas.rma.mv(ex.mv.capt, reestimate = FALSE, progbar = TRUE)
```
```{r}
summary(dfb.capt)
```



# Annual/perennial
```{r, eval=FALSE}
ex.mv.panp <- rma.mv(yi = yi,
                     V = vi,
                     random = ~ 1 | exp_ID / obs_ID,
                     data = ex,
                     mods = ~ factor(plant_anper) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.panp)
hat <- hatvalues(ex.mv.panp) / mean(hatvalues(ex.mv.panp))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "annual/perennial")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.panp <- rstudent(ex.mv.panp, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.panp, rstd.panp$resid > 1.96)
y <- subset(rstd.panp, rstd.panp$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.panp$k / 10
```
```{r, eval=FALSE}
dfb.panp <- dfbetas.rma.mv(ex.mv.panp, reestimate = FALSE, progbar = TRUE)  
```
```{r}
summary(dfb.panp)
```



# Grass/forb/shrub
```{r, eval=FALSE}
ex.mv.pgfs <- rma.mv(yi = yi,
                     V = vi,
                     random = ~ 1 | exp_ID / obs_ID,
                     data = ex,
                     mods = ~ factor(plant_gfs) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.pgfs)
hat <- hatvalues(ex.mv.pgfs) / mean(hatvalues(ex.mv.pgfs))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "grass/forb/shrub")
abline(h = -3)
abline(h = 3)
abline(v = 2)

filter(ex, obs_ID == 257)[ , c("paper", "obs_ID", "plant_gfs")]
filter(ex, obs_ID == 258)[ , c("paper", "obs_ID", "plant_gfs")]
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.pgfs <- rstudent(ex.mv.pgfs, reestimate = FALSE, progbar = TRUE)  
```
```{r}
x <- subset(rstd.pgfs, rstd.pgfs$resid > 1.96)
y <- subset(rstd.pgfs, rstd.pgfs$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.pgfs$k / 10
```
```{r, eval=FALSE}
dfb.pgfs <- dfbetas.rma.mv(ex.mv.pgfs, reestimate = FALSE, progbar = TRUE)   
```
```{r}
summary(dfb.pgfs)
```
- Observations 257 and 258 are Habeck outliers (points are overlapping on plot).


# Annual/perennial and grass/forb/shrub
```{r, eval=FALSE}
ex.mv.papgfs <- rma.mv(yi = yi,
                     V = vi,
                     random = ~ 1 | exp_ID / obs_ID,
                     data = ex,
                     mods = ~ factor(plant_apgfs) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.papgfs)
hat <- hatvalues(ex.mv.papgfs) / mean(hatvalues(ex.mv.papgfs))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "annual/perennial and grass/forb/shrub")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.papgfs <- rstudent(ex.mv.papgfs, reestimate = FALSE, progbar = TRUE)  
```
```{r}
x <- subset(rstd.papgfs, rstd.papgfs$resid > 1.96)
y <- subset(rstd.papgfs, rstd.papgfs$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.papgfs$k / 10
```
```{r, eval=FALSE}
dfb.papgfs <- dfbetas.rma.mv(ex.mv.papgfs, reestimate = FALSE, progbar = TRUE)    
```
```{r}
summary(dfb.papgfs)
```



# Plot size
```{r, eval=FALSE}
ex.mv.plotc <- rma.mv(yi = yi,
                       V = vi,
                       random = ~ 1 | exp_ID / obs_ID,
                       data = ex,
                       mods = ~ factor(plotc) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.plotc)
hat <- hatvalues(ex.mv.plotc) / mean(hatvalues(ex.mv.plotc))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "plot")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.plotc <- rstudent(ex.mv.plotc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.plotc, rstd.plotc$resid > 1.96)
y <- subset(rstd.plotc, rstd.plotc$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.plotc$k / 10
```
```{r, eval=FALSE}
dfb.plotc <- dfbetas.rma.mv(ex.mv.plotc, reestimate = FALSE, progbar = TRUE) 
```
```{r}
summary(dfb.plotc)
```




# Seeding of native
```{r, eval=FALSE}
ex.mv.seedn <- rma.mv(yi = yi,
                      V = vi,
                      random = ~ 1 | exp_ID / obs_ID,
                      data = ex,
                      mods = ~ factor(seedn) - 1)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.seedn)
hat <- hatvalues(ex.mv.seedn) / mean(hatvalues(ex.mv.seedn))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "plot")
abline(h = -3)
abline(h = 3)
abline(v = 2)
filter(ex, obs_ID == 457)[ , c("paper", "obs_ID", "seedn")]
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.seedn <- rstudent(ex.mv.seedn, reestimate = FALSE, progbar = TRUE)
```
```{r}
x <- subset(rstd.seedn, rstd.seedn$resid > 1.96)
y <- subset(rstd.seedn, rstd.seedn$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.seedn$k / 10
```
```{r, eval=FALSE}
dfb.seedn <- dfbetas.rma.mv(ex.mv.seedn, reestimate = FALSE, progbar = TRUE) 
```
```{r}
summary(dfb.seedn)
```
- Observation 457 is a Habeck outlier.



# Model selection 14
```{r, eval=FALSE}
ex.ms14 <- ex[!apply(ex[ , c("region", "dlc", "C_type", "cratc", "capt", "plant_apgfs", "plotc")], 1, anyNA), ]

ex.mv.ms14 <- rma.mv(yi = yi,
                    V = vi,
                    random = ~ 1 | exp_ID / obs_ID,
                    data = ex.ms14,
                    mods = ~ 1 + dlc + plotc + region + plant_apgfs)
```
## Habeck method
```{r}
rstn <- rstandard(ex.mv.ms14)
hat <- hatvalues(ex.mv.ms14) / mean(hatvalues(ex.mv.ms14))
plot(hat, rstn$resid,
     xlab = "hat/mean hat",
     ylab = "standardised residuals",
     main = "model selection 14")
abline(h = -3)
abline(h = 3)
abline(v = 2)
```

## Viechtbauer method
Estimate
```{r, eval=FALSE}
rstd.ms14 <- rstudent(ex.mv.ms14, reestimate = FALSE, progbar = TRUE) 
```
```{r}
x <- subset(rstd.ms14, rstd.ms14$resid > 1.96)
y <- subset(rstd.ms14, rstd.ms14$resid < -1.96)
length(x[["resid"]]) + length(y[["resid"]])
ex.mv.ms14$k / 10
```
```{r, eval=FALSE}
dfb.ms14 <- dfbetas.rma.mv(ex.mv.ms14, reestimate = FALSE, progbar = TRUE) 
```
```{r}
summary(dfb.ms14)
```

